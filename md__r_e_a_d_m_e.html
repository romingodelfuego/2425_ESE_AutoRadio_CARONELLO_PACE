<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: TP de Synthèse – Autoradio</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">TP de Synthèse – Autoradio</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md28"></a></p>
<p>Ce TP propose d'utiliser une NUCLEO_L476RG afin de rediriger un signal audio. Nous utiliserons un shield afin de pouvoir interfacer la board avec les différents inputs et outputs nécessaires.</p>
<p>Voir ici la <a href="./audio_iface.pdf">datasheet : audio interface</a></p>
<p>Nous avons mis un point d'honneur sur l'organisation des fichiers. Pour vous aidez à vous y retrouver, nous avons documenté avec Doxygen le projet.</p><ul class="check">
<li class="checked">1. Shell RTOS</li>
</ul>
<ul class="check">
<li class="checked">2. Driver LED</li>
</ul>
<ul class="check">
<li class="checked">3.4 Générer un signal audio</li>
</ul>
<ul class="check">
<li class="checked">3.5 Rediriger un signal audio</li>
<li class="unchecked">4. Visualiser au Vu mettre</li>
</ul>
<ul class="check">
<li class="unchecked">5. Filtre RC</li>
</ul>
<ul class="check">
<li class="unchecked">6. Effet Audio</li>
</ul>
<h1><a class="anchor" id="autotoc_md29"></a>
1. Démarrage</h1>
<p>On souhaite ici implémenter un shell dans un os temps réel. On créer donc une tache avec une gestion d'erreurs </p><div class="fragment"><div class="line"> c</div>
<div class="line">xTaskCreate(shell_run,  &quot;Shell&quot;, TASK_STACK_DEPTH_SHELL, NULL, TASK_PRIORITY_SHELL, &amp;h_task_shell) != pdPASS ? Error_Handler():(void)0;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md30"></a>
2. Le GPIO Expander et le VU-Metre</h1>
<h2><a class="anchor" id="autotoc_md31"></a>
2.1 Configuration</h2>
<ol type="1">
<li>Quelle est la référence du GPIO Expander ? Vous aurez besoin de sa datasheet, téléchargez-la. <blockquote class="doxtable">
<p>&zwj;<a href="./MCP23017_Data_Sheet_DS20001952-2998473.pdf">MCP23S17-E/SO</a></p>
</blockquote>
</li>
<li>Sur le STM32, quel SPI est utilisé ? &gt;On utilise le SPI3 avec le branchement suivant &gt;<code> &gt;PB5 | SPI3_MOSI &gt;PC10 | SPI3_SCK &gt;PC11 | SPI3_MISO &gt;</code></li>
<li>Quels sont les paramètres à configurer dans STM32CubeIDE ? Frame Format : MOTOROLA \ Data Size : 8 bits \ First Bit : MSB On réduit également le Baud rate à 312.5 kBits/s </li>
</ol>
<h2><a class="anchor" id="autotoc_md32"></a>
2.3 Driver</h2>
<p>On écrit un driver qui communique avec le GPIO expander pour allumer ou eteindre les LEDs qui y sont reliée à ces branches. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> MCP23S17_init(<span class="keywordtype">void</span>);</div>
<div class="line"><a class="code hl_enumeration" href="stm32l4xx__hal__def_8h.html#a63c0679d1cb8b8c684fbb0632743478f">HAL_StatusTypeDef</a> MCP23S17_WriteRegister(uint8_t reg, uint8_t data);</div>
<div class="line">uint8_t MCP23S17_ReadRegister(uint8_t reg);</div>
<div class="ttc" id="astm32l4xx__hal__def_8h_html_a63c0679d1cb8b8c684fbb0632743478f"><div class="ttname"><a href="stm32l4xx__hal__def_8h.html#a63c0679d1cb8b8c684fbb0632743478f">HAL_StatusTypeDef</a></div><div class="ttdeci">HAL_StatusTypeDef</div><div class="ttdoc">HAL Status structures definition.</div><div class="ttdef"><b>Definition</b> stm32l4xx_hal_def.h:39</div></div>
</div><!-- fragment --><p> Dans le shell on utilise ces fonctions pour choisir l'état de la LED. </p><div class="fragment"><div class="line"> c</div>
<div class="line">void subfunct_led(char **argv){</div>
<div class="line">    int GPIO = atoi(argv[1]);</div>
<div class="line">    uint8_t i=(uint8_t) strtol(argv[2], NULL, 10);</div>
<div class="line">    if (GPIO == atoi(&quot;A&quot;)){</div>
<div class="line">        MCP23S17_WriteRegister(0x12, (0xFF&lt;&lt;i)&amp;0xFF) == HAL_OK ? debug(START,&quot;MCP23S17 - GPIOA&quot;) : debug(D_ERROR,&quot;MCP23S17 - GPIOA&quot;);</div>
<div class="line">    }else if (GPIO == atoi(&quot;B&quot;)){</div>
<div class="line">        MCP23S17_WriteRegister(0x13, (0xFF&lt;&lt;i)&amp;0xFF) == HAL_OK ? debug(START,&quot;MCP23S17 - GPIOB&quot;) : debug(D_ERROR,&quot;MCP23S17 - GPIOB&quot;);</div>
<div class="line">    }else {</div>
<div class="line">        debug(D_ERROR,&quot;Argument 2 : A ou B attendu\r\n&quot;);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> <h1><a class="anchor" id="autotoc_md33"></a>
3 Le CODEC Audio SGTL5000</h1>
<h2><a class="anchor" id="autotoc_md34"></a>
3.1 Configuration préalables</h2>
<ol type="1">
<li>Quelles pins sont utilisées pour l’I2C ? À quel I2C cela correspond dans le STM32 ? On utilise le I2C2 avec le branchement suivant : &gt;<code> &gt;PB10 | I2C2_SCL &gt;PB11 | I2C2_SDA &gt;</code> </li>
</ol>
<h2><a class="anchor" id="autotoc_md35"></a>
3.2 Configuration du CODEC par l’I2C</h2>
<p>On écrit également un driver pour communiquer avec le codec </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> sgtl5000_i2c_read_register(uint16_t reg_address, uint16_t * p_data);</div>
<div class="line"><span class="keywordtype">int</span> sgtl5000_i2c_write_register(uint16_t reg_address, uint16_t data);</div>
<div class="line"><span class="keywordtype">int</span> sgtl5000_i2c_set_bit(uint16_t reg_address, uint16_t mask);</div>
<div class="line"><span class="keywordtype">int</span> sgtl5000_i2c_clear_bit(uint16_t reg_address, uint16_t mask);</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md36"></a>
3.4 Génération de signal audio</h2>
<p>Dans le .ioc, on configue le block A2 pour être en <code>Master with Master Clock</code> pour gérer la transmission. Et le block B2 comme un <code>Synchronous Slave</code> pour gérer la réception. Pour générer un signal triangle, on n'active seulement le canal A2 du I2S et on transmet par DMA le bufffer rempli pour être un triangle.  </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; SIZE_SAI_BUFFER / 2; i++) {</div>
<div class="line">    <span class="comment">// Montée du triangle</span></div>
<div class="line">    data_SAI_rx[i] = (uint16_t)((<span class="keywordtype">float</span>)i / (SIZE_SAI_BUFFER / 2) * UINT16_MAX);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = SIZE_SAI_BUFFER / 2; i &lt; SIZE_SAI_BUFFER; i++) {</div>
<div class="line">    <span class="comment">// Descente du triangle</span></div>
<div class="line">    data_SAI_rx[i] = (uint16_t)((<span class="keywordtype">float</span>)(SIZE_SAI_BUFFER - i) / (SIZE_SAI_BUFFER / 2) * UINT16_MAX);</div>
<div class="line">}</div>
<div class="line"><a class="code hl_define" href="group___s_a_i___exported___macros.html#ga8568947265caaaa934bdf78ce781049f">__HAL_SAI_ENABLE</a>(&amp;<a class="code hl_variable" href="sai_8h.html#ac6d5feeed703ab4c5947f651e33eac84">hsai_BlockA2</a>);</div>
<div class="line">HAL_SAI_Transmit_DMA(&amp;<a class="code hl_variable" href="sai_8h.html#ac6d5feeed703ab4c5947f651e33eac84">hsai_BlockA2</a>, (uint8_t*)data_SAI_rx, SIZE_SAI_BUFFER);</div>
<div class="ttc" id="agroup___s_a_i___exported___macros_html_ga8568947265caaaa934bdf78ce781049f"><div class="ttname"><a href="group___s_a_i___exported___macros.html#ga8568947265caaaa934bdf78ce781049f">__HAL_SAI_ENABLE</a></div><div class="ttdeci">#define __HAL_SAI_ENABLE(__HANDLE__)</div><div class="ttdoc">Enable SAI.</div><div class="ttdef"><b>Definition</b> stm32l4xx_hal_sai.h:746</div></div>
<div class="ttc" id="asai_8h_html_ac6d5feeed703ab4c5947f651e33eac84"><div class="ttname"><a href="sai_8h.html#ac6d5feeed703ab4c5947f651e33eac84">hsai_BlockA2</a></div><div class="ttdeci">SAI_HandleTypeDef hsai_BlockA2</div><div class="ttdef"><b>Definition</b> sai.c:28</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md37"></a>
3.5 Bypass Numérique</h2>
<p>Pour créer un bypass il nous suffit de recevoir le signal depuis le block B2 pour ensuite le transmettre sur le block A2. Ici nous ne faisons aucun traitement sur le signal. </p><div class="fragment"><div class="line"><a class="code hl_define" href="group___s_a_i___exported___macros.html#ga8568947265caaaa934bdf78ce781049f">__HAL_SAI_ENABLE</a>(&amp;hsai_BlockB2);</div>
<div class="line"><a class="code hl_define" href="group___s_a_i___exported___macros.html#ga8568947265caaaa934bdf78ce781049f">__HAL_SAI_ENABLE</a>(&amp;<a class="code hl_variable" href="sai_8h.html#ac6d5feeed703ab4c5947f651e33eac84">hsai_BlockA2</a>);</div>
<div class="line">HAL_SAI_Receive_DMA(&amp;hsai_BlockB2, (uint8_t*)data_SAI_rx, SIZE_SAI_BUFFER);</div>
<div class="line">HAL_SAI_Transmit_DMA(&amp;<a class="code hl_variable" href="sai_8h.html#ac6d5feeed703ab4c5947f651e33eac84">hsai_BlockA2</a>, (uint8_t*)data_SAI_rx, SIZE_SAI_BUFFER)</div>
</div><!-- fragment --><p> Nous avons tester en envoyant depuis un port jack de nos ordinateurs une musique, puis nous avons ecouter depuis la prise jack de sortie sur des ecouteurs filaires la musique. Le son n'est vraiment pas bon, il semble que les aigues soient complètement filtrés.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
4. Visualisation</h2>
<p>Nous êtions proches de proposer un vu-metre sur ce TP. Nous avions créer une tache, créer des notifications lors de la fin de la réception DMA qui notifiait la tache VU-Metre. Le point bloquant que nous n'avons pas eu le temps de traiter est l'allumage des LED selon la specification VU.</p>
<p>Dans le code, nous avons tenter une première méthode dans laquelle nous regardions si la moyenne du signal était comprise entre certain seuil. Malheureusement ce n'est pas ainsi que l'echelle VU fonctionne.</p>
<p>Il fautdrait donc implémenter une correspondance entre le signal et l'échelle VU : <a href="https://fr.wikipedia.org/wiki/VU-m%C3%A8tre">WIKIPEDIA - Vu Mètre</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
